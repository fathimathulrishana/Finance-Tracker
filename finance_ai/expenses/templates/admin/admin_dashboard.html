{% extends 'base.html' %}
{% block title %}Admin Dashboard | Finance Tracker{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <div>
      <p class="text-uppercase small text-muted mb-1">Admin Control Center</p>
      <h2 class="fw-semibold mb-1">Welcome back, {{ request.user.first_name|default:request.user.username }}</h2>
      <p class="text-muted mb-0">Monitor user growth, spending velocity, and system health at a glance.</p>
    </div>
    <div class="btn-group">
      <a href="{% url 'admin_manage_users' %}" class="btn btn-outline-primary">Manage Users</a>
      <a href="{% url 'admin_manage_expenses' %}" class="btn btn-outline-secondary">Manage Expenses</a>
      <a href="{% url 'admin_reports' %}" class="btn btn-primary">Reports</a>
    </div>
  </div>

  <style>
    .card-spotlight { border: none; color: #fff; }
    .card-spotlight .icon { font-size: 1.8rem; }
    .bg-sky { background: linear-gradient(135deg, #0d6efd 0%, #4dabf7 100%); }
    .bg-emerald { background: linear-gradient(135deg, #16a34a 0%, #3bc47c 100%); }
    .bg-amber { background: linear-gradient(135deg, #f59e0b 0%, #f8b84e 100%); }
    .bg-indigo { background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); }
    .card-hover { transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .metric-label { letter-spacing: 0.03em; font-size: 0.85rem; text-transform: uppercase; }
    .coming-soon-badge { font-size: 0.75rem; letter-spacing: 0.05em; }
  </style>

  <!-- Metrics -->
  <div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-sky card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Users</p>
            <h3 class="fw-bold mb-0">{{ total_users }}</h3>
          </div>
          <i class="bi bi-people-fill icon"></i>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-emerald card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Expenses</p>
            <h3 class="fw-bold mb-0">{{ total_expenses }}</h3>
          </div>
          <i class="bi bi-receipt icon"></i>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-amber card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Amount</p>
            <h3 class="fw-bold mb-0">${{ total_amount }}</h3>
          </div>
          <i class="bi bi-cash-coin icon"></i>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-indigo card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Avg Per Expense</p>
            <h3 class="fw-bold mb-0">${{ avg_expense }}</h3>
          </div>
          <i class="bi bi-graph-up icon"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Actions -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
      <a href="{% url 'admin_manage_users' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-people" style="font-size: 1.8rem; color: #0d6efd;"></i>
          <p class="fw-semibold mt-2 mb-1">Manage Users</p>
          <small class="text-muted">Activate, deactivate, delete</small>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-lg-3">
      <a href="{% url 'admin_manage_expenses' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-wallet2" style="font-size: 1.8rem; color: #16a34a;"></i>
          <p class="fw-semibold mt-2 mb-1">Manage Expenses</p>
          <small class="text-muted">Review, filter, delete</small>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-lg-3">
      <a href="{% url 'admin_reports' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-bar-chart-line" style="font-size: 1.8rem; color: #f59e0b;"></i>
          <p class="fw-semibold mt-2 mb-1">Reports</p>
          <small class="text-muted">Export CSV / PDF</small>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-lg-3">
      <a href="/admin/" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-shield-lock" style="font-size: 1.8rem; color: #6366f1;"></i>
          <p class="fw-semibold mt-2 mb-1">Django Admin</p>
          <small class="text-muted">Superuser controls</small>
        </div>
      </a>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Spend by Category (This Month)</h5>
            <span class="badge text-bg-light">Live</span>
          </div>
          <canvas id="categoryChart" height="220" aria-label="Category distribution"></canvas>
          <p class="text-muted small mt-3 mb-0">Insight: spot categories with outsized spend to adjust budgets.</p>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">12-Month Trend</h5>
            <span class="badge text-bg-light">Rolling</span>
          </div>
          <canvas id="trendChart" height="220" aria-label="Monthly trend"></canvas>
          <p class="text-muted small mt-3 mb-0">Trend: identify growth, seasonality, or anomalies over the year.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent activity -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Recent Expenses</h5>
            <a href="{% url 'admin_manage_expenses' %}" class="btn btn-sm btn-outline-primary">View all</a>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Category</th>
                  <th class="text-end">Amount</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {% for expense in recent_expenses %}
                  <tr>
                    <td>{{ expense.date|date:'M d, Y' }}</td>
                    <td>{{ expense.user.username }}</td>
                    <td>{{ expense.category }}</td>
                    <td class="text-end">${{ expense.amount }}</td>
                    <td>{{ expense.description|default:'—' }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">No recent expenses recorded.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Coming soon -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Risk &amp; Alerts</h5>
            <span class="badge text-bg-secondary coming-soon-badge">Coming soon</span>
          </div>
          <ul class="mb-0 text-muted small">
            <li>Budget breach alerts by category</li>
            <li>Velocity spikes detection with email notifications</li>
            <li>Exportable audit log of admin actions</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Engagement</h5>
            <span class="badge text-bg-secondary coming-soon-badge">Coming soon</span>
          </div>
          <ul class="mb-0 text-muted small">
            <li>User activation funnels and retention cohorts</li>
            <li>Category heatmaps segmented by user groups</li>
            <li>Automated weekly health report to email</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const categoryLabels = JSON.parse('{{ category_labels|escapejs }}');
  const categoryValues = JSON.parse('{{ category_values|escapejs }}');
  const trendLabels = JSON.parse('{{ trend_labels|escapejs }}');
  const trendValues = JSON.parse('{{ trend_values|escapejs }}');

  function buildChart(ctx, config) {
    return new Chart(ctx, config);
  }

  const categoryCtx = document.getElementById('categoryChart');
  if (categoryCtx) {
    buildChart(categoryCtx, {
      type: 'bar',
      data: {
        labels: categoryLabels,
        datasets: [{
          label: 'Amount',
          data: categoryValues,
          backgroundColor: '#4dabf7',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }
      }
    });
  }

  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    buildChart(trendCtx, {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Monthly Spend',
          data: trendValues,
          fill: true,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.12)',
          tension: 0.35,
          pointRadius: 4,
          pointBackgroundColor: '#6366f1'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }
      }
    });
  }
</script>
{% endblock %}
