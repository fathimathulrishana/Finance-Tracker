{% extends 'base.html' %}
{% block title %}Admin Dashboard | Finance Tracker{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <p class="text-uppercase small text-muted mb-1"><i class="bi bi-shield-lock"></i> Admin Control Center</p>
      <h1 class="fw-bold mb-2">Admin Dashboard</h1>
      <p class="text-muted mb-0">System-wide analytics, user management, and expense oversight.</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'admin_manage_users' %}" class="btn btn-outline-primary"><i class="bi bi-people"></i> Manage Users</a>
      <a href="{% url 'admin_manage_expenses' %}" class="btn btn-outline-secondary"><i class="bi bi-wallet2"></i> Manage Expenses</a>
      <a href="{% url 'admin_reports' %}" class="btn btn-primary"><i class="bi bi-file-earmark-pdf"></i> Reports</a>
    </div>
  </div>

  <style>
    .card-spotlight { border: none; color: #fff; }
    .card-spotlight .icon { font-size: 1.8rem; }
    .bg-sky { background: linear-gradient(135deg, #0d6efd 0%, #4dabf7 100%); }
    .bg-emerald { background: linear-gradient(135deg, #16a34a 0%, #3bc47c 100%); }
    .bg-amber { background: linear-gradient(135deg, #f59e0b 0%, #f8b84e 100%); }
    .bg-indigo { background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); }
    .card-hover { transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .metric-label { letter-spacing: 0.03em; font-size: 0.85rem; text-transform: uppercase; }
    .coming-soon-badge { font-size: 0.75rem; letter-spacing: 0.05em; }
  </style>

  <!-- System Metrics Cards (4 columns) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-sky card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Users</p>
            <h3 class="fw-bold mb-0">{{ total_users }}</h3>
            <small class="text-white-50">Active in system</small>
          </div>
          <i class="bi bi-people-fill icon text-white-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-emerald card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Expenses</p>
            <h3 class="fw-bold mb-0">{{ total_expenses }}</h3>
            <small class="text-white-50">All users combined</small>
          </div>
          <i class="bi bi-receipt icon text-white-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-amber card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Total Amount</p>
            <h3 class="fw-bold mb-0">₹{{ total_amount }}</h3>
            <small class="text-white-50">System-wide spending</small>
          </div>
          <i class="bi bi-cash-coin icon text-white-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3">
      <div class="card card-spotlight bg-indigo card-hover h-100">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <p class="metric-label mb-1 text-white-50">Top Category</p>
            <h3 class="fw-bold mb-0">{{ most_spent }}</h3>
            <small class="text-white-50">Most spent across users</small>
          </div>
          <i class="bi bi-tag icon text-white-50"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Actions Cards (3 perfectly balanced cards) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6 col-lg-4">
      <a href="{% url 'admin_manage_users' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-people" style="font-size: 2rem; color: #0d6efd;"></i>
          <p class="fw-semibold mt-2 mb-1">Manage Users</p>
          <small class="text-muted">View, activate, deactivate</small>
        </div>
      </a>
    </div>
    <div class="col-md-6 col-lg-4">
      <a href="{% url 'admin_manage_expenses' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-wallet2" style="font-size: 2rem; color: #16a34a;"></i>
          <p class="fw-semibold mt-2 mb-1">Manage Expenses</p>
          <small class="text-muted">Review and filter transactions</small>
        </div>
      </a>
    </div>
    <div class="col-md-6 col-lg-4">
      <a href="{% url 'admin_reports' %}" class="card card-hover text-decoration-none h-100">
        <div class="card-body text-center">
          <i class="bi bi-file-earmark-pdf" style="font-size: 2rem; color: #f59e0b;"></i>
          <p class="fw-semibold mt-2 mb-1">Export Reports</p>
          <small class="text-muted">CSV & PDF downloads</small>
        </div>
      </a>
    </div>
  </div>

  <!-- Charts Section: System-Wide Analytics -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="card-title mb-0"><i class="bi bi-pie-chart"></i> Category Distribution</h5>
              <small class="text-muted">All users combined</small>
            </div>
            <span class="badge text-bg-info">System-wide</span>
          </div>
          <canvas id="categoryChart" height="240" aria-label="Category distribution"></canvas>
          <p class="text-muted small mt-3 mb-0"><strong>Insight:</strong> Shows which expense categories dominate across all users. Use to understand platform trends.</p>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="card-title mb-0"><i class="bi bi-graph-up"></i> 12-Month Trend</h5>
              <small class="text-muted">Monthly expense growth</small>
            </div>
            <span class="badge text-bg-success">Live Data</span>
          </div>
          <canvas id="trendChart" height="240" aria-label="Monthly trend"></canvas>
          <p class="text-muted small mt-3 mb-0"><strong>Insight:</strong> Tracks platform expense volume over time. Identify seasonality and growth patterns.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity: Last 10 Expenses -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Recent System Activity</h5>
              <small class="text-muted">Last 10 expenses across all users</small>
            </div>
            <a href="{% url 'admin_manage_expenses' %}" class="btn btn-sm btn-outline-primary">View All Expenses</a>
          </div>

          {% if recent_expenses %}
          <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
              <thead class="table-light">
                <tr>
                  <th style="width: 15%;">Date</th>
                  <th style="width: 20%;">Username</th>
                  <th style="width: 15%;">Category</th>
                  <th class="text-end" style="width: 15%;">Amount</th>
                  <th style="width: 35%;">Description</th>
                </tr>
              </thead>
              <tbody>
                {% for expense in recent_expenses %}
                <tr>
                  <td>
                    <span class="badge text-bg-light text-dark">{{ expense.date|date:'M d, Y' }}</span>
                  </td>
                  <td>
                    <strong>{{ expense.user.username }}</strong>
                    <br><small class="text-muted">ID: {{ expense.user.id }}</small>
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ expense.category }}</span>
                  </td>
                  <td class="text-end">
                    <strong class="text-success">₹{{ expense.amount|floatformat:2 }}</strong>
                  </td>
                  <td>
                    <small>{{ expense.description|default:'<em class="text-muted">No description</em>' }}</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> No expenses recorded yet.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const categoryLabels = JSON.parse('{{ category_labels|escapejs }}');
  const categoryValues = JSON.parse('{{ category_values|escapejs }}');
  const trendLabels = JSON.parse('{{ trend_labels|escapejs }}');
  const trendValues = JSON.parse('{{ trend_values|escapejs }}');

  function buildChart(ctx, config) {
    return new Chart(ctx, config);
  }

  const categoryCtx = document.getElementById('categoryChart');
  if (categoryCtx) {
    buildChart(categoryCtx, {
      type: 'bar',
      data: {
        labels: categoryLabels,
        datasets: [{
          label: 'Amount',
          data: categoryValues,
          backgroundColor: '#4dabf7',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }
      }
    });
  }

  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    buildChart(trendCtx, {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Monthly Spend',
          data: trendValues,
          fill: true,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.12)',
          tension: 0.35,
          pointRadius: 4,
          pointBackgroundColor: '#6366f1'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }
      }
    });
  }
</script>
{% endblock %}
